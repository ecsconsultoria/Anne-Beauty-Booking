<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Vip & Bella Admin</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Vip & Bella</h1>
        <p>Admin</p>
      </div>
      
      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item active">ğŸ“Š Dashboard</a>
        <a href="#" class="nav-item" onclick="openAvailabilityModal(event)">ğŸ• Gerenciar HorÃ¡rios</a>
        <a href="#" class="nav-item" onclick="generateLink(event)">ğŸ”— Gerar Link</a>
        <a href="/admin/login" class="nav-item">ğŸšª Sair</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1>Dashboard de Agendamentos</h1>
        <p>Visualize e gerencie todos os agendamentos</p>
      </div>

      <!-- EstatÃ­sticas -->
      <div class="stats-grid">
        <div class="stat-card total-entrada">
          <div class="stat-number">R$ <%= stats.totalEntrada %></div>
          <div class="stat-label">Total Entrada</div>
        </div>
        <div class="stat-card">
          <div class="stat-number"><%= stats.total %></div>
          <div class="stat-label">Total de Agendamentos</div>
        </div>
        <div class="stat-card confirmed">
          <div class="stat-number"><%= stats.confirmed %></div>
          <div class="stat-label">Confirmados</div>
        </div>
        <div class="stat-card completed">
          <div class="stat-number"><%= stats.completed %></div>
          <div class="stat-label">ConcluÃ­dos</div>
        </div>
        <div class="stat-card cancelled">
          <div class="stat-number"><%= stats.cancelled %></div>
          <div class="stat-label">Cancelados</div>
        </div>
      </div>

      <!-- Tabela de Agendamentos -->
      <div class="appointments-section">
        <h2>PrÃ³ximos Agendamentos</h2>
        
        <% if (appointments.length > 0) { %>
          <div class="table-responsive">
            <table class="appointments-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>HorÃ¡rio</th>
                  <th>Cliente</th>
                  <th>ServiÃ§o</th>
                  <th>Valor</th>
                  <th>Telefone</th>
                  <th>Status</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody>
                <% appointments.forEach(apt => { %>
                  <% 
                    const [year, month, day] = apt.appointment_date.split('-');
                    const formattedDate = `${day}/${month}/${year}`;
                  %>
                  <tr class="appointment-row <%= apt.status %>">
                    <td><%= formattedDate %></td>
                    <td><%= apt.appointment_time %></td>
                    <td><%= apt.client_name %></td>
                    <td><%= formatServiceName(apt.service) %></td>
                    <td class="service-price"><strong>R$ <%= (apt.service_price || 0).toFixed(2) %></strong></td>
                    <td>
                      <a href="https://wa.me/55<%= apt.client_phone.replace(/\D/g, '') %>" target="_blank">
                        <%= apt.client_phone %>
                      </a>
                    </td>
                    <td class="actions">
                      <% if (apt.status === 'confirmed') { %>
                        <select class="status-select" onchange="updateStatus('<%= apt.id %>', this.value); this.value = '<%= apt.status %>'">
                          <option value="">Alterar Status</option>
                          <option value="completed">âœ… ConcluÃ­do</option>
                          <option value="cancelled">âŒ Cancelado</option>
                        </select>
                      <% } else { %>
                        <span class="status-badge <%= apt.status %>">
                          <%= formatStatus(apt.status) %>
                        </span>
                      <% } %>
                      <button class="btn-small btn-info" onclick="showDetailsModal({id: '<%= apt.id %>', email: `<%= apt.client_email || '' %>`, notes: `<%= apt.notes || '' %>`, name: `<%= apt.client_name %>`})">â„¹ï¸ Detalhes</button>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="no-data">Nenhum agendamento futuro.</p>
        <% } %>
      </div>
    </main>
  </div>

  <!-- Modal para Gerenciar HorÃ¡rios -->
  <div id="availabilityModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAvailabilityModal()">&times;</span>
      <h2>ğŸ• Gerenciar HorÃ¡rios e Datas</h2>
      
      <div class="availability-controls">
        <h3>Bloquear HorÃ¡rio EspecÃ­fico</h3>
        <div class="form-group">
          <label>Data:</label>
          <input type="date" id="unavailDate" required>
        </div>
        <div class="form-group">
          <label>HorÃ¡rio:</label>
          <select id="unavailTime" required>
            <option value="">Selecione</option>
            <option value="10:00">10:00 - 11:00 (SÃ¡bado)</option>
            <option value="11:00">11:00 - 12:00 (SÃ¡bado)</option>
            <option value="12:00">12:00 - 13:00 (SÃ¡bado)</option>
            <option value="13:00">13:00 - 14:00 (SÃ¡bado)</option>
            <option value="14:00">14:00 - 15:00</option>
            <option value="15:00">15:00 - 16:00</option>
            <option value="16:00">16:00 - 17:00</option>
            <option value="17:00">17:00 - 18:00</option>
          </select>
        </div>
        <div class="form-group">
          <label>Motivo (opcional):</label>
          <input type="text" id="unavailReason" placeholder="Ex: ManutenÃ§Ã£o, Feriado, etc">
        </div>
        <button onclick="blockTimeSlot()" class="btn btn-primary">ğŸ”’ Bloquear HorÃ¡rio</button>
      </div>

      <hr style="margin: 20px 0;">

      <div class="availability-controls">
        <h3>Bloquear Data Inteira</h3>
        <div class="form-group">
          <label>Data:</label>
          <input type="date" id="unavailFullDate" required>
        </div>
        <div class="form-group">
          <label>Motivo:</label>
          <input type="text" id="unavailFullReason" placeholder="Ex: Fechado, Feriado, Evento">
        </div>
        <button onclick="blockFullDate()" class="btn btn-danger">ğŸš« Bloquear Data Inteira</button>
      </div>

      <hr style="margin: 20px 0;">

      <div class="unavailable-list">
        <h3>HorÃ¡rios/Datas Bloqueadas</h3>
        <div id="unavailableSlotsList" class="slots-list">
          <p>Carregando...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Link -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeLinkModal()">&times;</span>
      <h2>Link de Agendamento</h2>
      <p>Compartilhe este link com seus clientes:</p>
      
      <div class="link-box">
        <input type="text" id="bookingLink" readonly>
        <button onclick="copyLink()" class="btn btn-small">ğŸ“‹ Copiar</button>
      </div>

      <div class="link-box">
        <label>Ou compartilhe direto no WhatsApp:</label>
        <a id="whatsappLink" href="#" target="_blank" class="btn btn-primary">
          ğŸ’¬ Abrir WhatsApp
        </a>
      </div>
    </div>
  </div>

  <!-- Modal para Detalhes do Agendamento -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeDetailsModal()">&times;</span>
      <h2>ğŸ“‹ Detalhes do Agendamento</h2>
      
      <div class="details-content">
        <div class="detail-row">
          <strong>ğŸ‘¤ Cliente:</strong>
          <span id="detailName"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ“§ Email:</strong>
          <span id="detailEmail"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ“± Telefone:</strong>
          <span id="detailPhone"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ’… ServiÃ§o:</strong>
          <span id="detailService"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ“… Data:</strong>
          <span id="detailDate"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ• Hora:</strong>
          <span id="detailTime"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ’° Valor:</strong>
          <span id="detailPrice"></span>
        </div>
        <div class="detail-row">
          <strong>ğŸ“ ObservaÃ§Ãµes:</strong>
          <span id="detailNotes"></span>
        </div>
        <div class="detail-row">
          <strong>Status:</strong>
          <span id="detailStatus"></span>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/admin.js"></script>
  <script>
    function formatServiceName(service) {
      const names = {
        'manicure': 'Manicure',
        'pedicure': 'Pedicure',
        'cilios': 'CÃ­lios',
        'combo_mani_pedi': 'Manicure + Pedicure',
        'combo_completo': 'Manicure + Pedicure + CÃ­lios'
      };
      return names[service] || service;
    }

    function formatStatus(status) {
      const statuses = {
        'confirmed': 'âœ… Confirmado',
        'completed': 'âœ”ï¸ ConcluÃ­do',
        'cancelled': 'âŒ Cancelado'
      };
      return statuses[status] || status;
    }

    function generateLink(e) {
      e.preventDefault();
      fetch('/admin/generate-link?password=anne2025')
        .then(res => res.json())
        .then(data => {
          document.getElementById('bookingLink').value = data.link;
          document.getElementById('whatsappLink').href = data.whatsapp;
          document.getElementById('linkModal').style.display = 'block';
        });
    }

    function openAvailabilityModal(e) {
      e.preventDefault();
      document.getElementById('availabilityModal').style.display = 'block';
      loadUnavailableSlots();
    }

    function closeAvailabilityModal() {
      document.getElementById('availabilityModal').style.display = 'none';
    }

    function loadUnavailableSlots() {
      fetch('/admin/api/unavailable-slots')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('unavailableSlotsList');
          if (data.length === 0) {
            list.innerHTML = '<p>Nenhum horÃ¡rio bloqueado</p>';
            return;
          }
          list.innerHTML = data.map(slot => `
            <div class="unavail-item">
              <div>
                <strong>${new Date(slot.date + 'T00:00:00').toLocaleDateString('pt-BR')}</strong>
                Ã s <strong>${slot.time}</strong>
                ${slot.reason ? `<br><small>${slot.reason}</small>` : ''}
              </div>
              <button class="btn-small btn-danger" onclick="unblockSlot(${slot.id})">ğŸ”“ Desbloquear</button>
            </div>
          `).join('');
        });
    }

    function blockTimeSlot() {
      const date = document.getElementById('unavailDate').value;
      const time = document.getElementById('unavailTime').value;
      const reason = document.getElementById('unavailReason').value;

      if (!date || !time) {
        alert('âš ï¸ Data e horÃ¡rio sÃ£o obrigatÃ³rios!');
        return;
      }

      fetch('/admin/api/unavailable-slots', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, time, reason })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('âœ… HorÃ¡rio bloqueado!');
          document.getElementById('unavailDate').value = '';
          document.getElementById('unavailTime').value = '';
          document.getElementById('unavailReason').value = '';
          loadUnavailableSlots();
        }
      });
    }

    function blockFullDate() {
      const date = document.getElementById('unavailFullDate').value;
      const reason = document.getElementById('unavailFullReason').value;

      if (!date) {
        alert('âš ï¸ Data Ã© obrigatÃ³ria!');
        return;
      }

      fetch('/admin/api/unavailable-dates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, reason: reason || 'Data bloqueada' })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('âœ… Data inteira bloqueada!');
          document.getElementById('unavailFullDate').value = '';
          document.getElementById('unavailFullReason').value = '';
          loadUnavailableSlots();
        }
      });
    }

    function unblockSlot(id) {
      if (!confirm('Desbloquear este horÃ¡rio?')) return;

      fetch(`/admin/api/unavailable-slots/${id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('âœ… HorÃ¡rio desbloqueado!');
          loadUnavailableSlots();
        }
      });
    }

    function closeLinkModal() {
      document.getElementById('linkModal').style.display = 'none';
    }

    function closeDetailsModal() {
      document.getElementById('detailsModal').style.display = 'none';
    }

    function copyLink() {
      const link = document.getElementById('bookingLink');
      link.select();
      document.execCommand('copy');
      alert('Link copiado para a Ã¡rea de transferÃªncia!');
    }

    function updateStatus(id, status) {
      if (confirm('Tem certeza?')) {
        fetch(`/admin/api/appointments/${id}/${status === 'completed' ? 'complete' : 'cancel'}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            location.reload();
          }
        });
      }
    }

    function showDetailsModal(apt) {
      fetch(`/api/booking/${apt.id}`)
        .then(res => res.json())
        .then(data => {
          const [year, month, day] = data.appointment_date.split('-');
          const formattedDate = `${day}/${month}/${year}`;

          document.getElementById('detailName').textContent = data.client_name || '-';
          document.getElementById('detailEmail').textContent = data.client_email || 'NÃ£o informado';
          document.getElementById('detailPhone').textContent = data.client_phone || '-';
          document.getElementById('detailService').textContent = formatServiceName(data.service) || '-';
          document.getElementById('detailDate').textContent = formattedDate || '-';
          document.getElementById('detailTime').textContent = data.appointment_time || '-';
          document.getElementById('detailPrice').textContent = `R$ ${(data.service_price || 0).toFixed(2)}` || '-';
          document.getElementById('detailNotes').textContent = data.notes || 'Nenhuma observaÃ§Ã£o';
          document.getElementById('detailStatus').textContent = formatStatus(data.status) || '-';
          
          document.getElementById('detailsModal').style.display = 'block';
        })
        .catch(err => {
          console.error('Erro ao carregar detalhes:', err);
          alert('Erro ao carregar detalhes do agendamento');
        });
    }

    function showDetails(id) {
      alert('Detalhes do agendamento ID: ' + id);
    }

    // Fechar modal ao clicar fora
    window.onclick = function(event) {
      const modal = document.getElementById('linkModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }
  </script>
</body>
</html>
